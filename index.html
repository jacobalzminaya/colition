<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Alpha PRO v22 | Ultimate Edition</title>
    <style>
        :root {
            --bg-color: #040508;
            --panel-bg: rgba(10, 13, 17, 0.9);
            --up-neon: #00ff88; 
            --down-neon: #ff2e63; 
            --accent: #4a90e2;
            --text-dim: #717b87;
            --text-main: #ffffff;
            --border: #1c2128;
            --glow: rgba(74, 144, 226, 0.2);
        }

        body {
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #mouse-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1;
            cursor: crosshair;
            background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.7) 100%);
        }
        #mouse-overlay.active-radar { display: block; }

        .terminal {
            background: var(--panel-bg);
            width: 95%;
            max-width: 460px;
            border-radius: 24px;
            padding: 24px;
            border: 2px solid var(--border);
            position: relative;
            z-index: 10;
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: 900;
            margin-bottom: 15px;
            color: var(--text-dim);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #flow-chart {
            width: 100%;
            height: 80px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: block;
        }

        .selectors-grid {
            display: grid;
            grid-template-columns: 1.5fr 1.1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
        
        .btn {
            background: #161b22;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 2px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            cursor: pointer;
            flex: 1;
            transition: 0.2s;
        }
        
        .btn.active { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 0 15px var(--glow); 
        }

        .input-track {
            background: rgba(0,0,0,0.6);
            height: 45px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 22px;
            border: 1px solid var(--border);
        }

        .signal-zone {
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border-radius: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            overflow: hidden;
        }

        #big-icon { font-size: 80px; font-weight: bold; display: none; z-index: 2; }
        #op-status { font-size: 1.8rem; font-weight: 900; margin-top: 5px; z-index: 2; }
        #op-details { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; z-index: 2; }

        #mouseBtn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s ease;
        }
        #mouseBtn.radar-on { 
            background: var(--accent); 
            color: white; 
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4); 
        }

        #ia-report {
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 14px;
            font-size: 11px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }

        .feedback-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .feed-btn {
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-weight: 900;
            cursor: pointer;
            opacity: 0.1;
            pointer-events: none;
            border: none;
            transition: 0.3s;
        }
        .active-signal { opacity: 1 !important; pointer-events: auto !important; transform: scale(1.02); }

        /* PANEL TÁCTIL (Se muestra solo con Radar Activo) */
        #manual-touch-zone {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 70px;
            margin-top: 5px;
        }
        .touch-trigger {
            background: #111;
            border: 1px solid var(--border);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 0 #000;
        }
        .touch-trigger:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; background: #161b22; }
        .t-up { color: var(--up-neon); border-color: rgba(0, 255, 136, 0.3); }
        .t-down { color: var(--down-neon); border-color: rgba(255, 46, 99, 0.3); }

        .text-up { color: var(--up-neon) !important; text-shadow: 0 0 20px rgba(0, 255, 136, 0.6); }
        .text-down { color: var(--down-neon) !important; text-shadow: 0 0 20px rgba(255, 46, 99, 0.6); }
        .border-up { border-color: var(--up-neon) !important; box-shadow: 0 0 40px rgba(0, 255, 136, 0.1); }
        .border-down { border-color: var(--down-neon) !important; box-shadow: 0 0 40px rgba(255, 46, 99, 0.1); }

        #timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: var(--accent);
            transition: width linear;
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="mouse-overlay"></div>

<div class="terminal" id="main-terminal">
    <div class="header-info">
        <span id="speed-meter">MS: 0</span>
        <span id="power-index">POWER: 0.0</span>
        <span id="noise-index">NOISE: 0%</span>
    </div>

    <canvas id="flow-chart"></canvas>

    <div class="selectors-grid">
        <div class="btn-group" id="time-group">
            <button class="btn" onclick="setTime(5, this)">5S</button>
            <button class="btn active" onclick="setTime(15, this)">15S</button>
            <button class="btn" onclick="setTime(30, this)">30S</button>
            <button class="btn" onclick="setTime(60, this)">1M</button>
        </div>
        <div class="btn-group" id="risk-group">
            <button class="btn" onclick="setRisk(1, this)">N1</button>
            <button class="btn active" onclick="setRisk(2, this)">N2</button>
            <button class="btn" onclick="setRisk(3, this)">N3</button>
            <button id="flexBtn" class="btn" style="border-color:#8957e5" onclick="toggleFlexMode()">FLEX</button>
        </div>
    </div>

    <div class="input-track" id="live-track">
        <span style="color: var(--text-dim); font-size: 10px;">READY FOR SCAN</span>
    </div>

    <button id="mouseBtn" onclick="toggleMouse()">INICIAR SENSOR RADAR</button>

    <div class="signal-zone">
        <div id="big-icon"></div>
        <div id="op-status">SYSTEM IDLE</div>
        <div id="op-details">SCANNING DATA FLOW</div>
        <div id="timer-bar"></div>
    </div>

    <div id="ia-report">
        <div id="ia-logic" style="color: var(--text-dim); margin-bottom: 4px;">IA: WAITING SEQUENCE...</div>
        <div id="ia-stake" style="font-weight: 800; color: #fff;">STAKE SUGGESTION: --</div>
    </div>

    <div class="feedback-grid">
        <button id="winBtn" class="feed-btn" style="background:var(--up-neon); color: #000;" onclick="logResult(true)">WIN</button>
        <button id="lossBtn" class="feed-btn" style="background:var(--down-neon)" onclick="logResult(false)">LOSS</button>
    </div>

    <div id="manual-touch-zone">
        <div class="touch-trigger t-up" onclick="registerInput('A')">▲</div>
        <div class="touch-trigger t-down" onclick="registerInput('B')">▼</div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 10px; color: var(--text-dim); font-weight: 900;">
        <span>SESIÓN: <span id="stat-total" style="color:white">0</span></span>
        <span>ACCURACY: <span id="stat-winrate" style="color:white">0%</span></span>
    </div>
</div>

<script>
// --- ESTADO GLOBAL ---
let mouseEnabled = false, flexMode = false, sequence = [], tradeHistory = [];
let lastClickTime = 0, riskLevel = 2, selectedTime = 15;
let isSignalActive = false, countdownInterval = null;

const config = {
    racha: { 1: 3, 2: 4, 3: 5 },
    ruido: { 1: 65, 2: 55, 3: 45 }
};

const AudioEngine = {
    ctx: null,
    init() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },
    async play(type) {
        this.init();
        if (this.ctx.state === 'suspended') await this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.frequency.setValueAtTime(type === "COMPRA" ? 880 : 330, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.6);
        osc.start(); osc.stop(this.ctx.currentTime + 0.6);
        if(navigator.vibrate) navigator.vibrate(type === "COMPRA" ? [30, 10, 30] : [70]);
    }
};

const canvas = document.getElementById('flow-chart');
const ctx = canvas.getContext('2d');
let chartData = Array(40).fill(40);

function drawChart() {
    if (!mouseEnabled && sequence.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    requestAnimationFrame(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(74, 144, 226, 0.05)';
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=25) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle = '#4a90e2';
        ctx.lineWidth = 3;
        const step = canvas.width / (chartData.length - 1);
        chartData.forEach((val, i) => {
            const x = i * step;
            const y = (canvas.height / 2) + (val - 40) * 1.5;
            if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    });
}

function toggleMouse() {
    mouseEnabled = !mouseEnabled;
    AudioEngine.init();
    const overlay = document.getElementById('mouse-overlay');
    const btn = document.getElementById('mouseBtn');
    const touchPanel = document.getElementById('manual-touch-zone');
    
    overlay.classList.toggle('active-radar', mouseEnabled);
    btn.classList.toggle('radar-on', mouseEnabled);
    btn.innerText = mouseEnabled ? "SENSOR ACTIVO" : "INICIAR SENSOR RADAR";
    
    // Mostrar u ocultar botones táctiles según el radar
    touchPanel.style.display = mouseEnabled ? "grid" : "none";
    
    if(!mouseEnabled) resetUI();
}

// Función maestra de registro de entrada (SIN CAMBIOS EN LÓGICA)
function registerInput(val) {
    if (!mouseEnabled || isSignalActive) return;
    
    const now = Date.now();
    const diff = (lastClickTime === 0) ? 0 : now - lastClickTime;
    lastClickTime = now;

    sequence.push({val, diff});
    if(sequence.length > 20) sequence.shift();
    
    const lastVal = chartData[chartData.length - 1];
    chartData.push(val === 'A' ? lastVal - 8 : lastVal + 8);
    if(chartData.length > 40) chartData.shift();
    
    drawChart();
    updateLiveTrack();
    analyze();
}

// Overlay Mouse
document.getElementById('mouse-overlay').addEventListener('mousedown', (e) => {
    e.preventDefault();
    registerInput(e.button === 0 ? 'A' : 'B');
});

function analyze() {
    if (isSignalActive || sequence.length < 3) return;

    const seqStr = sequence.map(s => s.val).join('');
    const recentSpeed = sequence[sequence.length-1].diff;
    
    const oscillations = (seqStr.match(/AB|BA/g) || []).length;
    const noiseIndex = Math.min(100, Math.round((oscillations / Math.max(1, seqStr.length - 1)) * 100));

    const power = sequence.reduce((acc, s) => {
        let weight = 1000 / Math.max(s.diff, 40);
        return s.val === 'A' ? acc + weight : acc - weight;
    }, 0);

    document.getElementById('speed-meter').innerText = `MS: ${recentSpeed}`;
    document.getElementById('noise-index').innerText = `NOISE: ${noiseIndex}%`;
    document.getElementById('power-index').innerText = `POWER: ${power.toFixed(1)}`;

    let maxNoise = config.ruido[riskLevel];
    if (flexMode) maxNoise += 15;

    const rachaReq = config.racha[riskLevel];
    const isUp = new RegExp('A{' + rachaReq + '}$').test(seqStr);
    const isDown = new RegExp('B{' + rachaReq + '}$').test(seqStr);

    if (noiseIndex > maxNoise) {
        updateStatus("HIGH NOISE", "ESTABILIZANDO FLUJO...", "none");
    } else if (isUp || isDown) {
        triggerSignal(isUp ? "COMPRA" : "VENTA", power);
    }
}

function triggerSignal(type, power) {
    isSignalActive = true;
    AudioEngine.play(type);
    
    const status = document.getElementById('op-status');
    const icon = document.getElementById('big-icon');
    const term = document.getElementById('main-terminal');
    
    const lastResult = tradeHistory[tradeHistory.length - 1];
    document.getElementById('ia-stake').innerText = lastResult === false ? "STAKE: X2.2 (RECOVERY)" : "STAKE: BASE (SAFETY)";

    icon.style.display = "block";
    icon.innerText = type === "COMPRA" ? "▲" : "▼";
    status.innerText = type;
    status.className = type === "COMPRA" ? "text-up" : "text-down";
    icon.className = type === "COMPRA" ? "text-up" : "text-down";
    term.className = `terminal ${type === "COMPRA" ? 'border-up' : 'border-down'}`;

    document.getElementById('ia-logic').innerText = `IA: VECTOR ${Math.abs(power).toFixed(1)} CONFIRMADO`;
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.add('active-signal'));
    
    startCountdown();
}

function startCountdown() {
    const timerBar = document.getElementById('timer-bar');
    timerBar.style.transition = "none";
    timerBar.style.width = "100%";
    setTimeout(() => {
        timerBar.style.transition = `width ${selectedTime}s linear`;
        timerBar.style.width = "0%";
    }, 50);

    let timeLeft = selectedTime;
    countdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            resetUI(false);
        }
    }, 1000);
}

function resetUI(fullReset = true) {
    clearInterval(countdownInterval);
    isSignalActive = false;
    document.getElementById('main-terminal').className = "terminal";
    document.getElementById('op-status').innerText = "SYSTEM IDLE";
    document.getElementById('op-status').className = "";
    document.getElementById('op-details').innerText = "SCANNING DATA FLOW";
    document.getElementById('big-icon').style.display = "none";
    document.getElementById('timer-bar').style.width = "0%";
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.remove('active-signal'));
    if(fullReset) {
        sequence = [];
        chartData = Array(40).fill(40);
        drawChart();
        document.getElementById('live-track').innerHTML = '<span style="color:var(--text-dim);font-size:10px;">READY FOR SCAN</span>';
    }
}

function logResult(win) {
    tradeHistory.push(win);
    localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));
    updateStats();
    resetUI(true);
}

function updateStats() {
    const wins = tradeHistory.filter(x => x).length;
    const total = tradeHistory.length;
    document.getElementById('stat-total').innerText = total;
    document.getElementById('stat-winrate').innerText = total > 0 ? Math.round((wins/total)*100) + "%" : "0%";
}

function updateLiveTrack() {
    const track = document.getElementById('live-track');
    if (sequence.length === 0) return;
    track.innerHTML = sequence.slice(-8).map(s => `<span class="${s.val === 'A' ? 'text-up' : 'text-down'}">${s.val === 'A' ? '▲' : '▼'}</span>`).join(' ');
}

function setTime(s, btn) {
    selectedTime = s;
    document.querySelectorAll('#time-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function setRisk(l, btn) {
    riskLevel = l;
    document.querySelectorAll('#risk-group .btn:not(#flexBtn)').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function toggleFlexMode() {
    flexMode = !flexMode;
    document.getElementById('flexBtn').classList.toggle('active');
}

function updateStatus(txt, detail, iconDisp) {
    document.getElementById('op-status').innerText = txt;
    document.getElementById('op-details').innerText = detail;
    document.getElementById('big-icon').style.display = iconDisp;
}

const saved = localStorage.getItem('tradeHistory');
if(saved) {
    tradeHistory = JSON.parse(saved);
    updateStats();
}

drawChart();
</script>
</body>
</html>
