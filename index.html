<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Alpha PRO v22 | Full Logic</title>
    <style>
        :root {
            --bg-color: #040508;
            --panel-bg: #0a0d11;
            --up-neon: #00ff88; 
            --down-neon: #ff2e63; 
            --accent: #4a90e2;
            --text-dim: #717b87;
            --text-main: #ffffff;
            --border: #1c2128;
        }

        body {
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        #mouse-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1;
            cursor: crosshair;
            pointer-events: none;
        }
        #mouse-overlay.active-radar {
            display: block;
            pointer-events: auto;
            background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.5) 100%);
        }

        .terminal {
            background: var(--panel-bg);
            width: 95%;
            max-width: 460px;
            border-radius: 20px;
            padding: 20px;
            border: 2px solid var(--border);
            position: relative;
            z-index: 10;
            box-shadow: 0 40px 80px rgba(0,0,0,0.7);
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        /* SELECTORES COMPLETOS */
        .selectors-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group { display: flex; gap: 3px; flex-wrap: wrap; }
        .btn {
            background: #161b22;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 4px;
            border-radius: 5px;
            font-size: 9px;
            font-weight: 800;
            cursor: pointer;
            flex: 1;
            min-width: 30px;
        }
        .btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-flex { border-color: #8957e5; color: #8957e5; }
        .btn-flex.active { background: #8957e5; color: white; }

        /* VISUALIZADOR DE ESCRITURA (Lo que vas marcando) */
        .input-track {
            background: rgba(0,0,0,0.4);
            height: 30px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 14px;
            border: 1px solid #1c2128;
        }

        /* ZONA DE SEÑAL */
        .signal-zone {
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #big-icon { font-size: 80px; font-weight: bold; display: none; line-height: 1; }
        #op-status { font-size: 1.8rem; font-weight: 900; margin-top: 5px; }
        #op-details { font-size: 11px; color: var(--accent); margin-top: 5px; font-weight: 600; }

        #mouseBtn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        #mouseBtn.radar-on { background: var(--accent); color: white; }

        #ia-report {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            font-size: 11px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border);
        }

        .feedback-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .feed-btn {
            padding: 14px;
            border-radius: 10px;
            color: white;
            font-weight: 900;
            cursor: pointer;
            opacity: 0.15;
            pointer-events: none;
        }
        .active-signal { opacity: 1; pointer-events: auto; }

        /* Estilos dinámicos */
        .text-up { color: var(--up-neon); }
        .text-down { color: var(--down-neon); }
        .border-up { border-color: var(--up-neon) !important; }
        .border-down { border-color: var(--down-neon) !important; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.18.0/ort.min.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="mouse-overlay"></div>

<div class="terminal" id="main-terminal">
    <div class="header-info">
        <span id="speed-meter">LATENCIA: 0ms</span>
        <span id="noise-index">RUIDO: 0%</span>
    </div>

    <div class="selectors-grid">
        <div class="btn-group">
            <button class="btn" onclick="setTime(3, this)">3S</button>
            <button class="btn" onclick="setTime(5, this)">5S</button>
            <button class="btn active" onclick="setTime(10, this)">10S</button>
            <button class="btn" onclick="setTime(15, this)">15S</button>
            <button class="btn" onclick="setTime(30, this)">30S</button>
            <button class="btn" onclick="setTime(60, this)">1M</button>
        </div>
        <div class="btn-group">
            <button class="btn" onclick="setRisk(1, this)">N1</button>
            <button class="btn active" onclick="setRisk(2, this)">N2</button>
            <button class="btn" onclick="setRisk(3, this)">N3</button>
            <button id="flexBtn" class="btn btn-flex" onclick="toggleFlexMode()">FLEX</button>
        </div>
    </div>

    <div class="input-track" id="live-track">
        <span style="color: var(--text-dim); font-size: 10px;">FLUJO DE ENTRADA...</span>
    </div>

    <button id="mouseBtn" onclick="toggleMouse()">INICIAR SENSOR RADAR</button>

    <div class="signal-zone">
        <div id="big-icon"></div>
        <div id="op-status">SISTEMA IDLE</div>
        <div id="op-details">MONITORIZANDO PULSO DE MERCADO</div>
    </div>

    <div id="ia-report">
        <div id="ia-logic" style="color: var(--text-dim); margin-bottom: 3px;">IA: ESPERANDO SECUENCIA...</div>
        <div id="ia-stake" style="font-weight: 800; color: #fff;">GESTIÓN: SIN OPERACIÓN</div>
    </div>

    <div class="feedback-grid">
        <button id="winBtn" class="feed-btn" style="background:var(--up-neon); color: #000;" onclick="logResult(true)">WIN</button>
        <button id="lossBtn" class="feed-btn" style="background:var(--down-neon)" onclick="logResult(false)">LOSS</button>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 10px; color: var(--text-dim); font-weight: bold;">
        <span>SESIÓN: <span id="stat-total" style="color:white">0</span></span>
        <span>ACIERTO: <span id="stat-winrate" style="color:white">0%</span></span>
    </div>
</div>

<script>
let mouseEnabled = false, flexMode = false, sequence = [], tradeHistory = [];
let lastClickTime = 0, riskLevel = 2, ortSession = null;

const minRachaByLevel = {1: 3, 2: 4, 3: 5};
const noiseThresholdByLevel = {1: 65, 2: 55, 3: 50};

async function loadModel() {
    if (ortSession) return;
    try {
        ort.env.wasm.numThreads = 1;
        const response = await fetch('./quantum_model.onnx?v=' + Date.now());
        const buffer = await response.arrayBuffer();
        ortSession = await ort.InferenceSession.create(buffer, { executionProviders: ['wasm'] });
        document.getElementById('ia-logic').innerText = "IA: MOTOR ACTIVADO";
    } catch (e) { document.getElementById('ia-logic').innerText = "IA: MODO LOCAL"; }
}

function toggleMouse() {
    mouseEnabled = !mouseEnabled;
    const overlay = document.getElementById('mouse-overlay');
    const btn = document.getElementById('mouseBtn');
    overlay.classList.toggle('active-radar', mouseEnabled);
    btn.classList.toggle('radar-on', mouseEnabled);
    btn.innerText = mouseEnabled ? "RADAR EN LÍNEA" : "INICIAR SENSOR RADAR";
    if(mouseEnabled) loadModel(); else resetUI();
}

document.getElementById('mouse-overlay').addEventListener('mousedown', (e) => {
    if (!mouseEnabled) return;
    e.preventDefault();
    const now = Date.now();
    const diff = (lastClickTime === 0) ? 0 : now - lastClickTime;
    lastClickTime = now;
    let val = (e.button === 0) ? 'A' : (e.button === 2 ? 'B' : "");
    if(val !== "") {
        sequence.push({val, diff});
        if(sequence.length > 12) sequence.shift();
        updateLiveTrack();
        analyze();
    }
});

function updateLiveTrack() {
    const track = document.getElementById('live-track');
    track.innerHTML = sequence.map(s => 
        s.val === 'A' ? '<span class="text-up">▲</span>' : '<span class="text-down">▼</span>'
    ).join(' ');
}

async function analyze() {
    const seqStr = sequence.map(s => s.val).join('');
    const oscillationCount = (seqStr.match(/AB|BA/g) || []).length;
    const noiseIndex = Math.min(100, Math.round((oscillationCount / Math.max(1, seqStr.length - 1)) * 120));
    const recentAvgSpeed = sequence.slice(-5).reduce((acc, s) => acc + s.diff, 0) / Math.max(1, sequence.slice(-5).length);
    
    document.getElementById('speed-meter').innerText = `LATENCIA: ${Math.round(recentAvgSpeed)}ms`;
    document.getElementById('noise-index').innerText = `RUIDO: ${noiseIndex}%`;

    let noiseMax = noiseThresholdByLevel[riskLevel] + (flexMode ? 15 : 0);
    const isChoppy = noiseIndex > noiseMax;
    const minR = minRachaByLevel[riskLevel];

    let type = null, strength = 0;
    if (new RegExp('A{' + minR + ',}').test(seqStr) && !isChoppy) {
        type = "COMPRA"; strength = (seqStr.slice(-6).match(/A/g) || []).length + (recentAvgSpeed < 350 ? 2.5 : 1);
    } else if (new RegExp('B{' + minR + ',}').test(seqStr) && !isChoppy) {
        type = "VENTA"; strength = (seqStr.slice(-6).match(/B/g) || []).length + (recentAvgSpeed < 350 ? 2.5 : 1);
    }

    if (type && !isChoppy) showSignal(type, strength);
    else if (isChoppy) {
        document.getElementById('op-status').innerText = "RUIDO ALTO";
        document.getElementById('big-icon').style.display = "none";
    } else resetUI();
}

function showSignal(type, strength) {
    const status = document.getElementById('op-status');
    const icon = document.getElementById('big-icon');
    const term = document.getElementById('main-terminal');
    const iaL = document.getElementById('ia-logic');
    const iaS = document.getElementById('ia-stake');
    const prob = Math.min(99, (strength * 13));

    icon.style.display = "block";
    if (type === "COMPRA") {
        status.innerText = "COMPRA"; status.className = "text-up";
        icon.innerText = "▲"; icon.className = "text-up";
        term.className = "terminal border-up";
    } else {
        status.innerText = "VENTA"; status.className = "text-down";
        icon.innerText = "▼"; icon.className = "text-down";
        term.className = "terminal border-down";
    }
    iaL.innerText = `IA: FUERZA ${strength.toFixed(1)} | PROBABILIDAD ${prob.toFixed(0)}%`;
    iaS.innerText = prob > 88 ? "GESTIÓN: CONFIANZA ALTA (5-8% STAKE)" : "GESTIÓN: CONFIANZA MEDIA (2-4% STAKE)";
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.add('active-signal'));
}

function resetUI() {
    document.getElementById('op-status').innerText = "SISTEMA IDLE";
    document.getElementById('op-status').className = "";
    document.getElementById('big-icon').style.display = "none";
    document.getElementById('main-terminal').className = "terminal";
    document.getElementById('ia-logic').innerText = "IA: ANALIZANDO...";
    document.getElementById('ia-stake').innerText = "GESTIÓN: SIN OPERACIÓN";
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.remove('active-signal'));
}

function setTime(s, btn) {
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    sequence = []; document.getElementById('live-track').innerHTML = ""; resetUI();
}

function setRisk(l, btn) {
    riskLevel = l;
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function toggleFlexMode() {
    flexMode = !flexMode;
    document.getElementById('flexBtn').classList.toggle('active');
}

function logResult(win) {
    tradeHistory.push(win);
    document.getElementById('stat-total').innerText = tradeHistory.length;
    const wins = tradeHistory.filter(x => x).length;
    document.getElementById('stat-winrate').innerText = Math.round((wins/tradeHistory.length)*100) + "%";
    sequence = []; document.getElementById('live-track').innerHTML = ""; resetUI();
}
</script>
</body>
</html>
