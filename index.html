<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Alpha PRO v22 | Ultimate Edition</title>
<style>
    :root {
        --bg-color: #040508;
        --panel-bg: rgba(10, 13, 17, 0.9);
        --up-neon: #00ff88; 
        --down-neon: #ff2e63; 
        --accent: #4a90e2;
        --text-dim: #717b87;
        --text-main: #ffffff;
        --border: #1c2128;
        --glow: rgba(74, 144, 226, 0.2);
    }

    /* --- RESET Y BASE --- */
    body {  
        background: var(--bg-color);
        color: var(--text-main);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .terminal, .btn, #mouse-overlay, #manual-touch-zone, .touch-trigger {
        user-select: none;
        -webkit-user-select: none;
    }

    /* --- CAPA RADAR (BLINDADA) --- */
    #mouse-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 1; 
        cursor: crosshair;
        background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.7) 100%);
        touch-action: none;
    }
    #mouse-overlay.active-radar { display: block; }

    /* --- CONTENEDOR PRINCIPAL (TERMINAL) --- */
    .terminal {
        background: var(--panel-bg);
        width: 95%;
        max-width: 460px;
        border-radius: 24px;
        padding: 24px;
        border: 2px solid var(--border);
        position: relative;
        z-index: 10;
        box-shadow: 0 40px 80px rgba(0,0,0,0.8);
        backdrop-filter: blur(15px);
        /* Transición suave para cambios de color inducidos por RUIDO o CALIDAD */
        transition: background 0.5s ease, border-color 0.4s ease, box-shadow 0.4s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* --- INFORMACIÓN DE CABECERA --- */
    .header-info {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        font-weight: 900;
        margin-bottom: 15px;
        color: var(--text-dim);
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    /* --- GRÁFICO --- */
    #flow-chart {
        width: 100%;
        height: 80px;
        background: rgba(0,0,0,0.4);
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid var(--border);
        display: block;
    }

    /* --- SELECTORES Y BOTONES --- */
    .selectors-grid {
        display: grid;
        grid-template-columns: 1.5fr 1.1fr;
        gap: 12px;
        margin-bottom: 15px;
    }

    .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
    
    .btn {
        background: #161b22;
        border: 1px solid var(--border);
        color: var(--text-dim);
        padding: 8px 2px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 800;
        cursor: pointer;
        flex: 1;
        transition: 0.2s;
        position: relative;
        z-index: 11; /* Prioridad sobre el radar */
    }
    
    .btn.active { 
        background: var(--accent); 
        color: white; 
        border-color: var(--accent); 
        box-shadow: 0 0 15px var(--glow); 
    }

    .btn:active, .feed-btn:active, .touch-trigger:active {
        transform: scale(0.96);
        filter: brightness(1.2);
    }

    /* --- TRACK DE ENTRADAS --- */
    .input-track {
        background: rgba(0,0,0,0.6);
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-size: 20px;
        border: 1px solid var(--border);
    }

    /* --- ZONA DE SEÑALES --- */
    .signal-zone {
        height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border-radius: 20px;
        margin-bottom: 15px;
        border: 1px solid rgba(255,255,255,0.05);
        position: relative;
        overflow: hidden;
    }

    #big-icon { font-size: 80px; font-weight: bold; display: none; z-index: 2; }
    #op-status { font-size: 1.8rem; font-weight: 900; margin-top: 5px; z-index: 2; }
    #op-details { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; z-index: 2; }

    #mouseBtn {
        width: 100%;
        padding: 16px;
        border-radius: 14px;
        border: 2px solid var(--accent);
        background: transparent;
        color: var(--accent);
        font-weight: 900;
        cursor: pointer;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: 0.3s ease;
        z-index: 11;
    }
    #mouseBtn.radar-on { 
        background: var(--accent); 
        color: white; 
        box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4); 
    }
    #mouseBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #111;
        color: var(--text-dim);
        border-color: var(--text-dim);
    }

    /* --- REPORTES IA --- */
    #ia-report {
        background: rgba(0,0,0,0.5);
        border-radius: 12px;
        padding: 14px;
        font-size: 11px;
        margin-bottom: 15px;
        border-left: 4px solid var(--accent);
    }

    .feedback-grid { 
        display: none; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
        margin-bottom: 10px;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .signal-active .feedback-grid { display: grid; opacity: 1; }

    .feed-btn {
        padding: 16px;
        border-radius: 12px;
        color: #000 !important;
        font-weight: 900;
        cursor: pointer;
        border: none;
        z-index: 11;
    }

    /* --- TOUCH ZONE MANUAL --- */
    #manual-touch-zone {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        height: 70px;
        margin-top: 5px;
    }
    .touch-trigger {
        background: #111;
        border: 1px solid var(--border);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        cursor: pointer;
        box-shadow: 0 4px 0 #000;
        transition: all 0.08s;
        z-index: 11;
    }

    /* --- CLASES DE ESTADO (DINÁMICAS) --- */
    .text-up { color: var(--up-neon) !important; text-shadow: 0 0 20px rgba(0, 255, 136, 0.6); }
    .text-down { color: var(--down-neon) !important; text-shadow: 0 0 20px rgba(255, 46, 99, 0.6); }
    
    /* Bordes Neón para Señal Activa */
    .border-up { border-color: var(--up-neon) !important; box-shadow: 0 0 40px rgba(0, 255, 136, 0.2); }
    .border-down { border-color: var(--down-neon) !important; box-shadow: 0 0 40px rgba(255, 46, 99, 0.2); }

    /* Barra de Tiempo */
    #timer-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0%;
        height: 4px;
        background: var(--accent);
        transition: width linear;
        will-change: width;
    }

   /* --- RESPONSIVIDAD --- */
@media (max-width: 400px) {
    .terminal { padding: 15px; }
    #big-icon { font-size: 60px; }
    .selectors-grid { gap: 8px; }
    .btn { font-size: 9px; }
}

/* --- ANIMACIONES DE LATIDO (Sincronizadas y Suaves) --- */

/* Brillo del icono central durante señal */
@keyframes pulse-glow {
    0%, 100% { filter: brightness(1.0); transform: scale(1.0); }
    50%      { filter: brightness(1.15); transform: scale(1.05); } 
}

/* Latido para RUIDO ALTO (Rojo) */
@keyframes heartbeat-red {
    0%   { transform: scale(1.00); box-shadow: 0 0 15px rgba(255, 46, 99, 0.15); }
    50%  { transform: scale(1.03); box-shadow: 0 0 25px rgba(255, 46, 99, 0.35); }
    100% { transform: scale(1.00); box-shadow: 0 0 15px rgba(255, 46, 99, 0.15); }
}

/* Latido para RUIDO ALTO (Verde) */
@keyframes heartbeat-green {
    0%   { transform: scale(1.00); box-shadow: 0 0 15px rgba(0, 255, 136, 0.15); }
    50%  { transform: scale(1.03); box-shadow: 0 0 25px rgba(0, 255, 136, 0.35); }
    100% { transform: scale(1.00); box-shadow: 0 0 15px rgba(0, 255, 136, 0.15); }
}

/* --- CLASES DE ACTIVACIÓN --- */

.signal-active #big-icon {
    animation: pulse-glow 2.5s infinite ease-in-out;
}

.high-noise-heart-red {
    animation: heartbeat-red 2.5s infinite ease-in-out !important;
    border-color: rgba(255, 46, 99, 0.5) !important;
}

.high-noise-heart-green {
    animation: heartbeat-green 2.5s infinite ease-in-out !important;
    border-color: rgba(0, 255, 136, 0.5) !important;
}
/* Estilo base mejorado para los gatillos manuales */
.touch-trigger {
    background: #0a0d11;
    border: 1px solid var(--border);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    cursor: pointer;
    transition: all 0.1s ease;
    z-index: 11;
}

/* Color para el botón Alcista (A) */
.touch-trigger.t-up {
    color: var(--up-neon);
    border-color: rgba(0, 255, 136, 0.3);
    box-shadow: inset 0 0 10px rgba(0, 255, 136, 0.05);
}

/* Color para el botón Bajista (B) */
.touch-trigger.t-down {
    color: var(--down-neon);
    border-color: rgba(255, 46, 99, 0.3);
    box-shadow: inset 0 0 10px rgba(255, 46, 99, 0.05);
}

/* Efecto visual al tocar/hacer clic */
.touch-trigger.t-up:active {
    background: rgba(0, 255, 136, 0.1);
    transform: scale(0.95);
}

.touch-trigger.t-down:active {
    background: rgba(255, 46, 99, 0.1);
    transform: scale(0.95);
}
</style>
</head>
<body>

<div id="mouse-overlay"></div>

<div class="terminal" id="main-terminal">
    <div class="header-info">
        <span id="speed-meter">MS: 0</span>
        <span id="power-index">POWER: 0.0</span>
        <span id="noise-index">NOISE: 0%</span>
    </div>

    <canvas id="flow-chart"></canvas>

    <div class="selectors-grid">
        <div class="btn-group" id="time-group">
            <button class="btn" id="t5" onclick="setTime(5, this)">5S</button>
            <button class="btn" id="t15" onclick="setTime(15, this)">15S</button>
            <button class="btn" id="t30" onclick="setTime(30, this)">30S</button>
            <button class="btn" id="t60" onclick="setTime(60, this)">1M</button>
        </div>
        <div class="btn-group" id="risk-group">
            <button class="btn" id="r1" onclick="setRisk(1, this)">N1</button>
            <button class="btn" id="r2" onclick="setRisk(2, this)">N2</button>
            <button class="btn" id="r3" onclick="setRisk(3, this)">N3</button>
            <button id="flexBtn" class="btn" style="border-color:#8957e5" onclick="toggleFlexMode()">FLEX</button>
        </div>
    </div>

<!-- Campo 1: SOLO SÍMBOLOS (arriba) -->
<div class="input-track" id="symbols-track">
    <span style="color: var(--text-dim); font-size: 11px;">ACTIVA EL RADAR PARA INICIAR</span>
</div>

<!-- Campo 2: SOLO MENSAJES + botón undo (abajo) -->
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
    <div class="input-track" id="status-track" style="flex: 1; margin-bottom: 0;">
        <span id="status-message" style="color: var(--text-dim); font-size: 11px;">ESPERANDO SECUENCIA...</span>
    </div>
    
    <button onclick="undoLastInput()" title="Borrar último" style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); color: #ff2e63; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s;">
        ↶
    </button>
</div>

    <button id="mouseBtn" onclick="toggleMouse()">INICIAR SENSOR RADAR</button>

    <div class="signal-zone">
        <div id="big-icon"></div>
        <div id="op-status">SYSTEM IDLE</div>
        <div id="op-details">SCANNING DATA FLOW</div>
        <div id="timer-bar"></div>
    </div>

    <div id="ia-report">
        <div id="ia-logic" style="color: var(--text-dim); margin-bottom: 4px;">IA: WAITING SEQUENCE...</div>
        <div id="ia-stake" style="font-weight: 800; color: #fff;">STAKE SUGGESTION: --</div>
    </div>

    <div class="feedback-grid" id="f-grid">
        <button id="winBtn" class="feed-btn" style="background:var(--up-neon);" onclick="logResult(true)">WIN</button>
        <button id="lossBtn" class="feed-btn" style="background:var(--down-neon)" onclick="logResult(false)">LOSS</button>
    </div>

    <div id="manual-touch-zone">
        <div class="touch-trigger t-up" onclick="registerInput('A')">▲</div>
        <div class="touch-trigger t-down" onclick="registerInput('B')">▼</div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 10px; color: var(--text-dim); font-weight: 900;">
        <span>SESIÓN: <span id="stat-total" style="color:white">0</span></span>
        <span>ACCURACY: <span id="stat-winrate" style="color:white">0%</span></span>
    </div>
</div>

<script>
// --- ESTADO ---
let mouseEnabled = false, flexMode = false, sequence = [], tradeHistory = [];
let lastClickTime = 0, riskLevel = 2, selectedTime = 15;
let isSignalActive = false, signalCooldown = false, countdownInterval = null;
let perfectFlow = false;
const config = {
    racha: { 1: 3, 2: 4, 3: 5 },
    ruido: { 1: 65, 2: 55, 3: 45 }
};

const AudioEngine = {
    ctx: null,
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    async play(type) {
        this.init();
        if (this.ctx.state === 'suspended') await this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        if(type === "CLICK") {
            osc.frequency.setValueAtTime(1200, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.04, this.ctx.currentTime);
            osc.start(); osc.stop(this.ctx.currentTime + 0.03);
        } else {
            osc.frequency.setValueAtTime(type === "COMPRA" ? 880 : 330, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.6);
            osc.start(); osc.stop(this.ctx.currentTime + 0.6);
        }
        if(navigator.vibrate) navigator.vibrate(type === "COMPRA" ? [30, 10, 30] : (type === "VENTA" ? [70] : [10]));
    }
};

// --- CANVAS ---
const canvas = document.getElementById('flow-chart');
const ctx = canvas.getContext('2d');
const dpr = window.devicePixelRatio || 1;
canvas.width = canvas.offsetWidth * dpr;
canvas.height = canvas.offsetHeight * dpr;
ctx.scale(dpr, dpr);
let chartData = Array(40).fill(40);

function drawChart() {
    ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
    if (!mouseEnabled && sequence.length === 0) return;
    
    ctx.strokeStyle = 'rgba(74, 144, 226, 0.05)';
    ctx.lineWidth = 1;
    for(let i=0; i<canvas.offsetWidth; i+=25) {
        ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.offsetHeight); ctx.stroke();
    }

    ctx.beginPath();
    if (perfectFlow) {
        ctx.lineWidth = 6; 
        ctx.shadowBlur = 15;
        const lastVal = sequence[sequence.length-1]?.val;
        ctx.strokeStyle = lastVal === 'A' ? '#00ff88' : '#ff2e63';
        ctx.shadowColor = lastVal === 'A' ? 'rgba(0, 255, 136, 0.8)' : 'rgba(255, 46, 99, 0.8)';
    } else {
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#4a90e2';
        ctx.shadowBlur = 0;
    }

    const step = canvas.offsetWidth / (chartData.length - 1);
    chartData.forEach((val, i) => {
        const x = i * step;
        const y = (canvas.offsetHeight / 2) + (val - 40) * 1.5;
        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.shadowBlur = 0;
}

// CORRECCIÓN: Se añade 'e' para que event.currentTarget funcione siempre
function undoLastInput(e) {
    // 1. Bloqueo de seguridad: No borrar si no hay datos o si hay una señal activa
    if (sequence.length === 0 || isSignalActive) return;

    // --- INTEGRACIÓN INIWEB ---
    // Registramos la acción de "deshacer" en la base de datos antes de borrar el dato local
    const undoLog = {
        tabla: "nombre_personalizados",
        accion: "UNDO_INPUT",
        ultimo_valor: sequence[sequence.length - 1].val,
        puntos_restantes: sequence.length - 1,
        timestamp: new Date().toISOString()
    };
    console.log("Registrando corrección en Iniweb...", undoLog);
    // ---------------------------

    // 2. Retroceder lógica de datos
    sequence.pop();
    
    // Ajustar el gráfico: quitamos el último punto y reponemos el inicio para mantener la longitud
    if (chartData.length > 0) {
        chartData.pop();
        if (chartData.length < 40) chartData.unshift(40);
    }

    // Si borramos todo, reseteamos el cronómetro de clics
    if (sequence.length === 0) lastClickTime = 0;

    // 3. Ejecutar actualizaciones visuales y sonoras
    AudioEngine.play("CLICK"); 
    drawChart();
    updateSymbols();          // ← AGREGADO: actualiza símbolos arriba
    updateStatusMessage();    // ← AGREGADO: actualiza mensajes abajo
    analyze(); // Recalcular RUIDO y POWER tras borrar

    // 4. Feedback visual del botón (Compatibilidad total)
    // Usamos el evento 'e' pasado por el botón o el objeto global event
    const btn = e ? e.currentTarget : (typeof event !== 'undefined' ? event.currentTarget : null);
    
    if (btn) {
        const originalBg = "rgba(255, 255, 255, 0.03)";
        const originalBorder = "var(--border)";
        
        btn.style.transition = "all 0.1s ease";
        btn.style.background = "rgba(255, 46, 99, 0.3)";
        btn.style.borderColor = "#ff2e63";
        btn.style.transform = "scale(0.9)";
        
        setTimeout(() => {
            btn.style.background = originalBg;
            btn.style.borderColor = originalBorder;
            btn.style.transform = "scale(1)";
        }, 150);
    }
}

function toggleMouse() {
    mouseEnabled = !mouseEnabled;
    AudioEngine.init();
    const overlay = document.getElementById('mouse-overlay');
    const btn = document.getElementById('mouseBtn');
    overlay.classList.toggle('active-radar', mouseEnabled);
    btn.classList.toggle('radar-on', mouseEnabled);
    btn.innerText = mouseEnabled ? "SENSOR ACTIVO" : "INICIAR SENSOR RADAR";
    document.getElementById('manual-touch-zone').style.display = mouseEnabled ? "grid" : "none";
    updateLiveTrack();
    if(!mouseEnabled) resetUI(true);
}

function registerInput(val) {
    if (!mouseEnabled || isSignalActive || signalCooldown) return;

    AudioEngine.play("CLICK");
    const now = Date.now();
    const diff = (lastClickTime === 0) ? 0 : now - lastClickTime;
    lastClickTime = now;
    
    sequence.push({val, diff});
    if(sequence.length > 20) sequence.shift();
    
    const lastVal = chartData[chartData.length - 1] ?? 40;
    chartData.push(val === 'A' ? lastVal - 8 : lastVal + 8);
    if(chartData.length > 40) chartData.shift();
    
    drawChart();
    updateSymbols();          // símbolos arriba
    updateStatusMessage();    // mensajes abajo
    analyze();
}

// --- BLINDAJE ---
const radarOverlay = document.getElementById('mouse-overlay');
radarOverlay.addEventListener('mousedown', (e) => {
    e.preventDefault(); 
    if (e.button === 0) registerInput('A');
    else if (e.button === 2) registerInput('B');
});
radarOverlay.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); return false; });
radarOverlay.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
radarOverlay.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });

function analyze() {
    if (isSignalActive || sequence.length < 3 || signalCooldown) return;
    
    const lastDiff = sequence[sequence.length-1].diff;
    const recent = sequence.slice(-10); 
    const seqStr = recent.map(s => s.val).join('');
    const oscillations = (seqStr.match(/AB|BA/g) || []).length;
    const noiseIndex = Math.min(100, Math.round((oscillations / Math.max(1, seqStr.length - 1)) * 100));
    
    const power = sequence.reduce((acc, s) => {
        let weight = 1000 / Math.max(s.diff, 40);
        return s.val === 'A' ? acc + weight : acc - weight;
    }, 0);

    const terminal = document.getElementById('main-terminal');
    const iaLogic = document.getElementById('ia-logic');
    const lastVal = recent[recent.length - 1]?.val;

    // --- LÓGICA DE PERSISTENCIA Y ESTADOS VISUALES ---
    if (sequence.length >= 3) {
        
        if (noiseIndex > 30) {
            // CASO 1: RUIDO ALTO (Persistente hasta que baje de 30)
            window.perfectFlow = false;
            terminal.style.background = "var(--panel-bg)"; // Asegurar fondo base

            if (lastVal === 'A') {
                terminal.style.borderColor = "#ff2e63";
                terminal.style.boxShadow = "0 0 25px rgba(255, 46, 99, 0.3)";
                iaLogic.innerText = "⚠️ RUIDO ALTO: POSIBLE REVERSIÓN BAJISTA";
                iaLogic.style.color = "#ff2e63";
                terminal.classList.remove('high-noise-heart-green');
                terminal.classList.add('high-noise-heart-red'); 
            } else {
                terminal.style.borderColor = "#00ff88";
                terminal.style.boxShadow = "0 0 25px rgba(0, 255, 136, 0.3)";
                iaLogic.innerText = "⚠️ RUIDO ALTO: POSIBLE REBOTE ALCISTA";
                iaLogic.style.color = "#00ff88";
                terminal.classList.remove('high-noise-heart-red');
                terminal.classList.add('high-noise-heart-green');
            }
        } 
        else if (noiseIndex <= 15) {
            // CASO 2: CALIDAD TOTAL
            window.perfectFlow = true; 
            terminal.classList.remove('high-noise-heart-red', 'high-noise-heart-green');
            
            if (lastVal === 'A') {
                terminal.style.background = "linear-gradient(145deg, rgba(0, 255, 136, 0.08), var(--panel-bg))";
                terminal.style.borderColor = "#00ff88";
                iaLogic.innerText = "⭐ CALIDAD 100%: TENDENCIA ALCISTA LIMPIA";
                iaLogic.style.color = "#00ff88";
            } else {
                terminal.style.background = "linear-gradient(145deg, rgba(255, 46, 99, 0.08), var(--panel-bg))";
                terminal.style.borderColor = "#ff2e63";
                iaLogic.innerText = "⭐ CALIDAD 100%: TENDENCIA BAJISTA LIMPIA";
                iaLogic.style.color = "#ff2e63";
            }
        }
        else {
            // CASO 3: FLUJO NORMAL (Reset de estilos solo aquí)
            window.perfectFlow = false;
            terminal.classList.remove('high-noise-heart-red', 'high-noise-heart-green');
            terminal.style.background = "var(--panel-bg)";
            terminal.style.boxShadow = "0 40px 80px rgba(0,0,0,0.8)";
            terminal.style.borderColor = "var(--border)";
            iaLogic.innerText = "IA: ESCANEANDO FLUJO SEGURO...";
            iaLogic.style.color = "var(--text-dim)";
        }
    }

    // Actualización de indicadores
    document.getElementById('noise-index').innerText = `NOISE: ${noiseIndex}%`;
    document.getElementById('power-index').innerText = `POWER: ${power.toFixed(1)}`;
    document.getElementById('speed-meter').innerText = `MS: ${lastDiff}`;
    
    drawChart();

    // Lógica de disparo de señal
    const rachaReq = config.racha[riskLevel];
    let streak = 1;
    for (let i = recent.length - 2; i >= 0; i--) {
        if (recent[i].val === lastVal) streak++;
        else break;
    }

    let maxNoise = config.ruido[riskLevel];
    if (flexMode) maxNoise += 15;

    if (streak >= rachaReq && noiseIndex <= maxNoise) {
        triggerSignal(lastVal === 'A' ? "COMPRA" : "VENTA", power);
    }

    // ACTUALIZACIÓN DE CAMPOS VISUALES (esto es lo que faltaba dentro de la función)
    updateSymbols();          // símbolos arriba
    updateStatusMessage();    // mensajes abajo
}

function updateStatusMessage() {
    const statusMessage = document.getElementById('status-message');
    
    // Obtener noise actual
    const noiseText = document.getElementById('noise-index').innerText.replace('NOISE: ', '');
    const noiseNum = parseInt(noiseText) || 0;

    if (noiseNum > 30) {
        statusMessage.innerText = '⚠️ RUIDO ALTO';
        statusMessage.style.color = '#ff2e63';
        statusMessage.style.fontWeight = 'bold';
    } else if (noiseNum <= 15) {
        statusMessage.innerText = '⭐ CALIDAD ALTA';
        statusMessage.style.color = '#00ff88';
        statusMessage.style.fontWeight = 'bold';
    } else {
        statusMessage.innerText = 'ESCANEANDO...';
        statusMessage.style.color = 'var(--accent)';
    }
}

function updateSymbols() {
    const symbolsTrack = document.getElementById('symbols-track');
    
    if (sequence.length === 0) {
        symbolsTrack.innerHTML = mouseEnabled 
            ? '<span style="color:var(--text-dim);font-size:12px;">ESPERANDO ENTRADAS...</span>'
            : '<span style="color:var(--text-dim);font-size:11px;">ACTIVA EL RADAR PARA INICIAR</span>';
        return;
    }

    // Solo símbolos, sin mensajes
    const symbols = sequence.slice(-10).map(s => 
        `<span class="${s.val === 'A' ? 'text-up' : 'text-down'}" style="font-size:20px;">${s.val === 'A' ? '▲' : '▼'}</span>`
    ).join('  •  ');

    symbolsTrack.innerHTML = symbols;
}

// MEJORA: Función para activar/desactivar botones de configuración
function setLockControls(lock) {
    const btns = document.querySelectorAll('.btn-group .btn');
    btns.forEach(b => {
        b.disabled = lock;
        b.style.opacity = lock ? "0.3" : "1";
        b.style.pointerEvents = lock ? "none" : "auto";
    });
}

function triggerSignal(type, power) {
    isSignalActive = true;
    signalCooldown = true; 
    AudioEngine.play(type);
    
    // BLOQUEAR CONTROLES
    setLockControls(true);

    const btn = document.getElementById('mouseBtn');
    const originalText = btn.innerText;
    btn.innerText = "PROCESANDO VECTOR...";
    btn.disabled = true;

    document.getElementById('main-terminal').classList.add('signal-active');
    const lastResult = tradeHistory[tradeHistory.length - 1];
    document.getElementById('ia-stake').innerText = lastResult === false ? "STAKE: X2.2 (RECOVERY)" : "STAKE: BASE (SAFETY)";
    
    document.getElementById('big-icon').style.display = "block";
    document.getElementById('big-icon').innerText = type === "COMPRA" ? "▲" : "▼";
    document.getElementById('op-status').innerText = type;
    document.getElementById('op-status').className = type === "COMPRA" ? "text-up" : "text-down";
    document.getElementById('big-icon').className = type === "COMPRA" ? "text-up" : "text-down";
    document.getElementById('main-terminal').className = `terminal signal-active ${type === "COMPRA" ? 'border-up' : 'border-down'}`;
    document.getElementById('ia-logic').innerText = `IA: VECTOR ${Math.abs(power).toFixed(1)} CONFIRMADO`;
    
    startCountdown();
    
    setTimeout(() => { 
        signalCooldown = false; 
        btn.innerText = originalText;
        btn.disabled = false;
    }, 2500);
}

function startCountdown() {
    const timerBar = document.getElementById('timer-bar');
    timerBar.style.transition = "none";
    timerBar.style.width = "100%";
    setTimeout(() => {
        timerBar.style.transition = `width ${selectedTime}s linear`;
        timerBar.style.width = "0%";
    }, 50);
    let timeLeft = selectedTime;
    countdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) { clearInterval(countdownInterval); resetUI(false); }
    }, 1000);
}

function resetUI(fullReset = true) {
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
    isSignalActive = false;
    
    // DESBLOQUEAR CONTROLES (Protección para que puedas volver a configurar)
    if (typeof setLockControls === "function") setLockControls(false);

    // LIMPIEZA VISUAL DE BARRA Y TERMINAL
    const timerBar = document.getElementById('timer-bar');
    const terminal = document.getElementById('main-terminal');
    
    timerBar.style.transition = "none";
    timerBar.style.width = "0%";

    // ELIMINAR LATIDOS Y ESTADOS ACTIVOS (Para que no se queden pegados tras la señal)
    terminal.classList.remove(
        'signal-active', 
        'high-noise-heart-red', 
        'high-noise-heart-green',
        'border-up',
        'border-down'
    );
    
    // RESET DE TEXTOS Y ESTILOS BASE
    terminal.className = "terminal"; 
    terminal.style.background = "var(--panel-bg)";
    terminal.style.boxShadow = "0 40px 80px rgba(0,0,0,0.8)";
    terminal.style.borderColor = "var(--border)";
    
    document.getElementById('op-status').innerText = "SYSTEM IDLE";
    document.getElementById('op-status').className = "";
    document.getElementById('op-details').innerText = "SCANNING DATA FLOW";
    document.getElementById('big-icon').style.display = "none";
    
    // RESET DE DATOS (Solo si es un reset total)
    if(fullReset) {
        sequence = []; 
        chartData = Array(40).fill(40); 
        lastClickTime = 0;
        window.perfectFlow = false;
        document.getElementById('speed-meter').innerText = "MS: 0";
        document.getElementById('noise-index').innerText = "NOISE: 0%";
        document.getElementById('power-index').innerText = "POWER: 0.0";
        drawChart(); 
        updateLiveTrack();
    }
}

function saveConfig() {
    localStorage.setItem('quantum_config', JSON.stringify({
        time: selectedTime, risk: riskLevel, flex: flexMode
    }));
}

function loadConfig() {
    const saved = JSON.parse(localStorage.getItem('quantum_config'));
    if(saved) {
        selectedTime = saved.time; riskLevel = saved.risk; flexMode = saved.flex;
        document.getElementById(`t${selectedTime}`).classList.add('active');
        document.getElementById(`r${riskLevel}`).classList.add('active');
        if(flexMode) document.getElementById('flexBtn').classList.add('active');
    } else {
        document.getElementById('t15').classList.add('active');
        document.getElementById('r2').classList.add('active');
    }
}

function setTime(s, btn) {
    if(isSignalActive) return; // No permitir cambio en señal activa
    selectedTime = s;
    document.querySelectorAll('#time-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); saveConfig();
}

function setRisk(l, btn) {
    if(isSignalActive) return; // No permitir cambio en señal activa
    riskLevel = l;
    document.querySelectorAll('#risk-group .btn:not(#flexBtn)').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); saveConfig();
}

function toggleFlexMode() {
    if(isSignalActive) return;
    flexMode = !flexMode;
    document.getElementById('flexBtn').classList.toggle('active'); saveConfig();
}

function logResult(win) {
    tradeHistory.push(win);
    localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));
    updateStats();
    resetUI(false); 
}

function updateStats() {
    const wins = tradeHistory.filter(x => x).length;
    const total = tradeHistory.length;
    document.getElementById('stat-total').innerText = total;
    document.getElementById('stat-winrate').innerText = total > 0 ? Math.round((wins/total)*100) + "%" : "0%";
}

function updateLiveTrack() {
    const track = document.getElementById('live-track');
    if (sequence.length === 0) {
        track.innerHTML = mouseEnabled ? '<span style="color:var(--text-dim);font-size:12px;">ESPERANDO ENTRADAS...</span>' : '<span style="color:var(--text-dim);font-size:11px;">ACTIVA EL RADAR PARA INICIAR</span>';
        return;
    }
    track.innerHTML = sequence.slice(-8).map(s => `<span class="${s.val === 'A' ? 'text-up' : 'text-down'}">${s.val === 'A' ? '▲' : '▼'}</span>`).join('  •  ');
}

function updateStatus(txt, detail, iconDisp) {
    document.getElementById('op-status').innerText = txt;
    document.getElementById('op-details').innerText = detail;
    document.getElementById('big-icon').style.display = iconDisp;
}

loadConfig();
const hSaved = localStorage.getItem('tradeHistory');
if(hSaved) { tradeHistory = JSON.parse(hSaved); updateStats(); }
drawChart();

</script>


</body>
</html>




