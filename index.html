<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Alpha PRO v22 | Full Logic Corregido</title>
    <style>
        :root {
            --bg-color: #040508;
            --panel-bg: #0a0d11;
            --up-neon: #00ff88; 
            --down-neon: #ff2e63; 
            --accent: #4a90e2;
            --text-dim: #717b87;
            --text-main: #ffffff;
            --border: #1c2128;
        }

        body {
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        #mouse-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1;
            cursor: crosshair;
            background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.5) 100%);
        }
        #mouse-overlay.active-radar { display: block; pointer-events: auto; }

        .terminal {
            background: var(--panel-bg);
            width: 95%;
            max-width: 460px;
            border-radius: 20px;
            padding: 20px;
            border: 2px solid var(--border);
            position: relative;
            z-index: 10;
            box-shadow: 0 40px 80px rgba(0,0,0,0.7);
            transition: border 0.3s ease;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .selectors-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group { display: flex; gap: 3px; flex-wrap: wrap; }
        .btn {
            background: #161b22;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 4px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 800;
            cursor: pointer;
            flex: 1;
            transition: 0.2s;
        }
        .btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-flex { border-color: #8957e5; color: #8957e5; }
        .btn-flex.active { background: #8957e5; color: white; box-shadow: 0 0 10px rgba(137, 87, 229, 0.4); }

        .input-track {
            background: rgba(0,0,0,0.4);
            height: 35px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 18px;
            border: 1px solid #1c2128;
        }

        .signal-zone {
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #big-icon { font-size: 80px; font-weight: bold; display: none; line-height: 1; }
        #op-status { font-size: 1.8rem; font-weight: 900; margin-top: 5px; }
        #op-details { font-size: 11px; color: var(--accent); margin-top: 5px; font-weight: 600; }

        #mouseBtn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 15px;
            text-transform: uppercase;
            transition: 0.3s;
        }
        #mouseBtn.radar-on { background: var(--accent); color: white; }

        #ia-report {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            font-size: 11px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border);
        }

        .feedback-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .feed-btn {
            padding: 14px;
            border-radius: 10px;
            color: white;
            font-weight: 900;
            cursor: pointer;
            opacity: 0.15;
            pointer-events: none;
            border: none;
            transition: 0.3s;
        }
        .active-signal { opacity: 1; pointer-events: auto; transform: scale(1.02); }

        .text-up { color: var(--up-neon); text-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
        .text-down { color: var(--down-neon); text-shadow: 0 0 10px rgba(255, 46, 99, 0.4); }
        .border-up { border-color: var(--up-neon) !important; box-shadow: 0 0 20px rgba(0, 255, 136, 0.1); }
        .border-down { border-color: var(--down-neon) !important; box-shadow: 0 0 20px rgba(255, 46, 99, 0.1); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="mouse-overlay"></div>

<div class="terminal" id="main-terminal">
    <div class="header-info">
        <span id="speed-meter">LATENCIA: 0ms</span>
        <span id="noise-index">RUIDO: 0%</span>
    </div>

    <div class="selectors-grid">
        <div class="btn-group" id="time-group">
            <button class="btn" onclick="setTime(3, this)">3S</button>
            <button class="btn" onclick="setTime(5, this)">5S</button>
            <button class="btn active" onclick="setTime(10, this)">10S</button>
            <button class="btn" onclick="setTime(15, this)">15S</button>
            <button class="btn" onclick="setTime(30, this)">30S</button>
            <button class="btn" onclick="setTime(60, this)">1M</button>
        </div>
        <div class="btn-group" id="risk-group">
            <button class="btn" onclick="setRisk(1, this)">N1</button>
            <button class="btn active" onclick="setRisk(2, this)">N2</button>
            <button class="btn" onclick="setRisk(3, this)">N3</button>
            <button id="flexBtn" class="btn btn-flex" onclick="toggleFlexMode()">FLEX</button>
        </div>
    </div>

    <div class="input-track" id="live-track">
        <span style="color: var(--text-dim); font-size: 10px;">ESPERANDO ENTRADA...</span>
    </div>

    <button id="mouseBtn" onclick="toggleMouse()">INICIAR SENSOR RADAR</button>

    <div class="signal-zone">
        <div id="big-icon"></div>
        <div id="op-status">SISTEMA IDLE</div>
        <div id="op-details">MODO: ESTÁNDAR</div>
    </div>

    <div id="ia-report">
        <div id="ia-logic" style="color: var(--text-dim); margin-bottom: 3px;">IA: ESPERANDO SECUENCIA...</div>
        <div id="ia-stake" style="font-weight: 800; color: #fff;">GESTIÓN: SIN OPERACIÓN</div>
    </div>

    <div class="feedback-grid">
        <button id="winBtn" class="feed-btn" style="background:var(--up-neon); color: #000;" onclick="logResult(true)">WIN</button>
        <button id="lossBtn" class="feed-btn" style="background:var(--down-neon)" onclick="logResult(false)">LOSS</button>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 10px; color: var(--text-dim); font-weight: bold;">
        <span>SESIÓN: <span id="stat-total" style="color:white">0</span></span>
        <span>ACIERTO: <span id="stat-winrate" style="color:white">0%</span></span>
    </div>
</div>

<script>
let mouseEnabled = false, flexMode = false, sequence = [], tradeHistory = [];
let lastClickTime = 0, riskLevel = 2, selectedTime = 10;

// CONFIGURACIÓN DE NIVELES (Corregido: MinRacha y Filtro de Ruido)
const config = {
    racha: { 1: 3, 2: 4, 3: 5 },
    ruido: { 1: 65, 2: 55, 3: 45 }
};

function toggleMouse() {
    mouseEnabled = !mouseEnabled;
    const overlay = document.getElementById('mouse-overlay');
    const btn = document.getElementById('mouseBtn');
    overlay.classList.toggle('active-radar', mouseEnabled);
    btn.classList.toggle('radar-on', mouseEnabled);
    btn.innerText = mouseEnabled ? "RADAR ACTIVO (CLICK IZQ/DER)" : "INICIAR SENSOR RADAR";
    if(!mouseEnabled) resetUI();
}

// CAPTURA DE DATOS (Izquierdo = A / Derecho = B)
document.getElementById('mouse-overlay').addEventListener('mousedown', (e) => {
    if (!mouseEnabled) return;
    e.preventDefault();
    
    const now = Date.now();
    const diff = (lastClickTime === 0) ? 0 : now - lastClickTime;
    lastClickTime = now;

    let val = "";
    if (e.button === 0) val = 'A'; // Compra
    else if (e.button === 2) val = 'B'; // Venta

    if(val !== "") {
        sequence.push({val, diff});
        if(sequence.length > 15) sequence.shift();
        updateLiveTrack();
        analyze();
    }
});

function updateLiveTrack() {
    const track = document.getElementById('live-track');
    track.innerHTML = sequence.map(s => 
        s.val === 'A' ? '<span class="text-up">▲</span>' : '<span class="text-down">▼</span>'
    ).join(' ');
}

function analyze() {
    const seqStr = sequence.map(s => s.val).join('');
    
    // CÁLCULO DE RUIDO (Oscilaciones)
    const oscillations = (seqStr.match(/AB|BA/g) || []).length;
    const noiseIndex = Math.min(100, Math.round((oscillations / Math.max(1, seqStr.length - 1)) * 100));
    
    // VELOCIDAD DE ENTRADA
    const recentSpeed = sequence.length > 1 ? sequence[sequence.length-1].diff : 0;
    
    document.getElementById('speed-meter').innerText = `LATENCIA: ${recentSpeed}ms`;
    document.getElementById('noise-index').innerText = `RUIDO: ${noiseIndex}%`;

    // LÓGICA DE FILTROS (Ajustada por nivel y FLEX)
    let maxAllowedNoise = config.ruido[riskLevel];
    if (flexMode) maxAllowedNoise += 15; // El modo FLEX relaja el filtro de ruido

    const minR = config.racha[riskLevel];
    const isChoppy = noiseIndex > maxAllowedNoise;

    // ERROR CORREGIDO: Usamos '$' para asegurar que la racha es lo último que ocurrió
    const rachaCompra = new RegExp('A{' + minR + ',}$').test(seqStr);
    const rachaVenta = new RegExp('B{' + minR + ',}$').test(seqStr);

    if (isChoppy) {
        updateStatus("RUIDO ALTO", "FILTRANDO SEÑAL VOLÁTIL", "none");
    } else if (rachaCompra) {
        showSignal("COMPRA", minR);
    } else if (rachaVenta) {
        showSignal("VENTA", minR);
    } else {
        resetUI(false);
    }
}

function showSignal(type, power) {
    const status = document.getElementById('op-status');
    const icon = document.getElementById('big-icon');
    const term = document.getElementById('main-terminal');
    const iaL = document.getElementById('ia-logic');
    const iaS = document.getElementById('ia-stake');
    
    // Cálculo de probabilidad basado en el tiempo y el riesgo
    let prob = 70 + (power * 5) - (riskLevel * 2);
    if(flexMode) prob -= 5;

    icon.style.display = "block";
    icon.innerText = type === "COMPRA" ? "▲" : "▼";
    status.innerText = type;
    
    if (type === "COMPRA") {
        status.className = "text-up"; icon.className = "text-up";
        term.className = "terminal border-up";
    } else {
        status.className = "text-down"; icon.className = "text-down";
        term.className = "terminal border-down";
    }

    iaL.innerText = `IA: PATRÓN N${riskLevel} DETECTADO | ${selectedTime}S`;
    iaS.innerText = `CONFIANZA: ${Math.min(98, prob)}% | SUGERIDO: 3-5%`;
    
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.add('active-signal'));
}

function updateStatus(txt, detail, iconDisp) {
    document.getElementById('op-status').innerText = txt;
    document.getElementById('op-details').innerText = detail;
    document.getElementById('big-icon').style.display = iconDisp;
    document.getElementById('main-terminal').className = "terminal";
}

function resetUI(clearTrack = true) {
    updateStatus("SISTEMA IDLE", "ESPERANDO FLUJO DE DATOS", "none");
    document.getElementById('op-status').className = "";
    document.getElementById('ia-logic').innerText = "IA: ANALIZANDO...";
    document.getElementById('ia-stake').innerText = "GESTIÓN: SIN OPERACIÓN";
    document.querySelectorAll('.feed-btn').forEach(b => b.classList.remove('active-signal'));
    if(clearTrack) {
        sequence = [];
        document.getElementById('live-track').innerHTML = '<span style="color: var(--text-dim); font-size: 10px;">ESPERANDO ENTRADA...</span>';
    }
}

function setTime(s, btn) {
    selectedTime = s;
    document.querySelectorAll('#time-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    resetUI();
}

function setRisk(l, btn) {
    riskLevel = l;
    document.querySelectorAll('#risk-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Al cambiar de riesgo, re-analizamos si hay datos
    if(sequence.length > 0) analyze();
}

function toggleFlexMode() {
    flexMode = !flexMode;
    document.getElementById('flexBtn').classList.toggle('active');
    if(sequence.length > 0) analyze();
}

function logResult(win) {
    tradeHistory.push(win);
    document.getElementById('stat-total').innerText = tradeHistory.length;
    const wins = tradeHistory.filter(x => x).length;
    document.getElementById('stat-winrate').innerText = Math.round((wins/tradeHistory.length)*100) + "%";
    resetUI();
}
</script>
</body>
</html>
