<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Quantum Alpha v18.6 | IA + External Server Sync</title>
    <style>
        :root {
            --bg-color: #0d1117; --panel-bg: #161b22; --accent: #58a6ff;
            --up: #238636; --down: #da3633; --text: #c9d1d9; --gold: #f1e05a;
            --noise: #d29922; --flex-on: #8957e5;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        * { user-select: none; box-sizing: border-box; }

        .terminal { 
            background: var(--panel-bg); width: 520px; border: 2px solid #30363d; border-radius: 12px; padding: 25px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); position: relative; transition: all 0.3s ease;
        }
        
        /* Efectos visuales de se√±ales */
        .term-up { border-color: var(--up); box-shadow: 0 0 20px rgba(35, 134, 54, 0.4); }
        .term-down { border-color: var(--down); box-shadow: 0 0 20px rgba(218, 54, 51, 0.4); }

        .selectors { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .time-selector, .risk-selector { display: flex; gap: 5px; }
        
        .btn { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-size: 0.75rem; text-align: center; font-weight: bold; }
        .btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-flex { border-color: var(--flex-on); color: var(--flex-on); }
        .btn-flex.active { background: var(--flex-on) !important; color: white !important; }

        #mouseBtn { width:100%; padding:12px; margin-bottom:10px; border-radius:8px; cursor:pointer; background:#21262d; color:#f1e05a; font-weight:bold; border:1px solid #30363d; position: relative; z-index: 1000; }
        #mouse-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 500; cursor: crosshair; background: rgba(0,0,0,0.01); }

        .monitor { background: #010409; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 10px; border: 1px solid #30363d; }
        #last-sequence { font-size: 2.4rem; letter-spacing: 10px; font-family: 'Consolas', monospace; color: #fff; display: block; min-height: 45px; }
        
        .indicators { margin-top: 10px; display: flex; justify-content: center; gap: 20px; }
        #speed-meter { font-size: 0.8rem; color: var(--gold); }
        #noise-index { font-size: 0.8rem; color: var(--noise); }

        #op-status { font-weight: bold; font-size: 1.5rem; text-align: center; display: block; margin: 12px 0; color: #fff; min-height: 30px; }
        #op-confidence { font-size: 0.85rem; color: #8b949e; text-align: center; display: block; margin-bottom: 15px; min-height: 45px; border-bottom: 1px solid #30363d; padding-bottom: 10px; transition: color 0.3s; white-space: pre-line; }

        .feedback-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .feed-btn { padding: 15px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; opacity: 0.1; pointer-events: none; transition: 0.3s; font-size: 1.1rem; }
        .active-signal { opacity: 1 !important; pointer-events: auto !important; transform: scale(1.02); }

        .session-log { background: rgba(0,0,0,0.4); border-radius: 8px; padding: 15px; border: 1px solid #30363d; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { text-align: center; }
        .stat-label { font-size: 0.65rem; color: #8b949e; text-transform: uppercase; display: block; }
        .stat-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }

        .manual-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #30363d; }
        .touch-btn { padding: 12px; border-radius: 6px; border: 1px solid #30363d; background: #21262d; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; position: relative; z-index: 1000; }
        .touch-up { border-left: 4px solid var(--up); }
        .touch-down { border-left: 4px solid var(--down); }
        
        .btn-export { margin-top: 15px; width: 100%; padding: 10px; background: #21262d; color: var(--gold); border: 1px solid #30363d; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/ort.min.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="mouse-overlay"></div>

<div class="terminal" id="main-terminal">
    <div class="selectors">
        <div class="time-selector">
            <button class="btn active" onclick="setTime(10, this)">10S</button>
            <button class="btn" onclick="setTime(15, this)">15S</button>
            <button class="btn" onclick="setTime(30, this)">30S</button>
            <button class="btn" onclick="setTime(60, this)">1M</button>
        </div>
        <div class="risk-selector">
            <button class="btn" onclick="setRisk(1, this)">NIVEL 1</button>
            <button class="btn active" onclick="setRisk(2, this)">NIVEL 2</button>
            <button class="btn" onclick="setRisk(3, this)">NIVEL 3</button>
            <button id="flexBtn" class="btn btn-flex" onclick="toggleFlexMode()">FLEX: OFF</button>
        </div>
    </div>

    <button id="mouseBtn" onclick="toggleMouse()">ACTIVAR SENSOR RADAR</button>

    <div class="monitor">
        <span id="last-sequence">---</span>
        <div class="indicators">
            <span id="speed-meter">MOMENTUM: 0ms</span>
            <span id="noise-index">RUIDO: 0%</span>
        </div>
    </div>

    <span id="op-status">IDLE</span>
    <div id="op-confidence">IA: DESCONECTADA</div>

    <div class="feedback-container">
        <button id="winBtn" class="feed-btn" style="background:var(--up)" onclick="logResult(true)">WIN</button>
        <button id="lossBtn" class="feed-btn" style="background:var(--down)" onclick="logResult(false)">LOSS</button>
    </div>

    <div class="session-log">
        <div class="stat-card">
            <span class="stat-label">Total Trades</span>
            <span id="stat-total" class="stat-val">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Win Rate</span>
            <span id="stat-winrate" class="stat-val">0%</span>
        </div>
    </div>

    <div class="manual-controls">
        <span class="manual-label">Modo Manual / Touch</span>
        <button class="touch-btn touch-up" onclick="injectManual('A')">‚¨ÜÔ∏è ALCISTA</button>
        <button class="touch-btn touch-down" onclick="injectManual('B')">‚¨áÔ∏è BAJISTA</button>
    </div>

    <button class="btn-export" onclick="exportData()">EXPORTAR SESI√ìN (CSV)</button>
</div>

<script>
    let mouseEnabled = false, flexMode = false, sequence = [], tradeHistory = [];
    let lastClickTime = 0, lastSignalTime = 0, riskLevel = 2, lastSignalData = null;
    let ortSession = null;

    const minRachaByLevel = {1: 3, 2: 4, 3: 5};
    const noiseThresholdByLevel = {1: 65, 2: 55, 3: 50};

    // 1. CARGA DE MODELO (MODO ESTABLE SIN SIMD)
    async function loadModel() {
        if (ortSession) return;
        
        // CONFIGURACI√ìN DE COMPATIBILIDAD CR√çTICA
        ort.env.wasm.numThreads = 1; 
        ort.env.wasm.simd = false; // Desactiva SIMD para evitar el error TypeError: Lt[m]

        try {
            const modelUrl = 'https://raw.githubusercontent.com/jacobalzminaya/colition/main/quantum_model.onnx?v=' + Date.now();
            const response = await fetch(modelUrl);
            if (!response.ok) throw new Error("Archivo no encontrado en GitHub");
            
            const buffer = await response.arrayBuffer();
            
            // Creaci√≥n de sesi√≥n con proveedor WASM puro
            ortSession = await ort.InferenceSession.create(buffer, { 
                executionProviders: ['wasm'],
                graphOptimizationLevel: 'all' 
            });
            
            document.getElementById('op-confidence').innerText = "SISTEMA IA: CONECTADO";
            document.getElementById('op-confidence').style.color = "#58a6ff";
            console.log("‚úÖ IA Quantum vinculada con √©xito.");
        } catch (err) { 
            console.error("‚ùå Fallo de carga:", err);
            document.getElementById('op-confidence').innerText = "IA: ERROR DE COMPATIBILIDAD WASM";
            document.getElementById('op-confidence').style.color = "#da3633";
        }
    }

    // 2. V√çNCULO AUTOM√ÅTICO CON SERVIDOR EXTERNO (AJUSTADO)
    async function syncToExternalServer(tradeData) {
        // Vincula aqu√≠ la URL de tu servidor externo
        const SERVER_URL = "https://tu-servidor-externo.com/api/save_trade"; 
        try {
            await fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tradeData)
            });
            console.log("‚úÖ Sincronizado con servidor externo.");
        } catch (e) {
            console.warn("‚ö†Ô∏è Servidor externo no configurado o fuera de l√≠nea.");
        }
    }

    function logResult(isWin) {
        if (!lastSignalData) return;
        const resultData = {
            ...lastSignalData,
            resultado: isWin ? 1 : 0,
            timestamp: new Date().toISOString()
        };

        tradeHistory.push(resultData);
        localStorage.setItem('quantum_v18_trades', JSON.stringify(tradeHistory));
        
        syncToExternalServer(resultData);
        updateStats();
        resetUI();
    }

    // 3. L√ìGICA DE AN√ÅLISIS
    async function analyze() {
        const seqStr = sequence.map(s => s.val).join('');
        const terminal = document.getElementById('main-terminal');
        const confElement = document.getElementById('op-confidence');
        document.getElementById('last-sequence').innerText = seqStr || '---';

        const oscillationCount = (seqStr.match(/AB|BA/g) || []).length;
        const noiseIndex = Math.min(100, Math.round((oscillationCount / Math.max(1, seqStr.length - 1)) * 120));
        const recentAvgSpeed = sequence.slice(-5).reduce((acc, s) => acc + s.diff, 0) / Math.max(1, sequence.slice(-5).length);

        document.getElementById('speed-meter').innerText = `MOMENTUM: ${Math.round(recentAvgSpeed)}ms`;
        document.getElementById('noise-index').innerText = `RUIDO: ${noiseIndex}%`;

        let noiseMax = noiseThresholdByLevel[riskLevel] + (flexMode ? 15 : 0);
        const isChoppy = noiseIndex > noiseMax;
        const minR = minRachaByLevel[riskLevel];
        
        let type = null;
        if (new RegExp('A{' + minR + ',}').test(seqStr) && !isChoppy) type = "COMPRA";
        else if (new RegExp('B{' + minR + ',}').test(seqStr) && !isChoppy) type = "VENTA";

        if (type && (Date.now() - lastSignalTime > 5000)) {
            let strength = (seqStr.slice(-minR).match(/[AB]/g) || []).length + (recentAvgSpeed < 300 ? 3 : 1);
            lastSignalTime = Date.now();
            lastSignalData = { type, strength, noise: noiseIndex, risk: riskLevel, flex: flexMode };
            
            terminal.className = 'terminal ' + (type === "COMPRA" ? 'term-up' : 'term-down');
            document.getElementById('op-status').innerText = "üöÄ " + type;
            document.querySelectorAll('.feed-btn').forEach(b => b.classList.add('active-signal'));

            // Predicci√≥n IA
            if (ortSession) {
                try {
                    const inputTensor = new ort.Tensor('float32', new Float32Array([strength, noiseIndex, riskLevel, flexMode?1:0]), [1, 4]);
                    const results = await ortSession.run({ input: inputTensor });
                    const prob = results.prob_win.data[0];
                    confElement.innerText = `FUERZA: ${strength.toFixed(1)} | IA PREDICT: ${Math.round(prob*100)}%`;
                    confElement.style.color = prob > 0.75 ? '#f1e05a' : '#58a6ff';
                } catch (e) { console.error("Error inferencia:", e); }
            }
        }
    }

    // --- FUNCIONES DE SOPORTE ---
    function setRisk(level, button) {
        riskLevel = level;
        document.querySelectorAll('.risk-selector .btn:not(.btn-flex)').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
    }

    function toggleFlexMode() {
        flexMode = !flexMode;
        document.getElementById('flexBtn').classList.toggle('active');
        document.getElementById('flexBtn').innerText = flexMode ? "FLEX: ON" : "FLEX: OFF";
    }

    function toggleMouse() {
        mouseEnabled = !mouseEnabled;
        document.getElementById('mouse-overlay').style.display = mouseEnabled ? "block" : "none";
        document.getElementById('mouseBtn').style.background = mouseEnabled ? "#f1e05a" : "#21262d";
        if (mouseEnabled) loadModel();
    }

    document.getElementById('mouse-overlay').addEventListener('mousedown', (e) => {
        const now = Date.now();
        const diff = lastClickTime === 0 ? 0 : now - lastClickTime;
        lastClickTime = now;
        let val = (e.button === 0) ? 'B' : (e.button === 2 ? 'A' : "");
        if(val !== "") {
            sequence.push({val, diff});
            if(sequence.length > 12) sequence.shift();
            analyze();
        }
    });

    function updateStats() {
        const total = tradeHistory.length;
        const wins = tradeHistory.filter(t => t.resultado === 1).length;
        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-winrate').innerText = total > 0 ? Math.round((wins/total)*100)+"%" : "0%";
    }

    function resetUI() {
        document.getElementById('main-terminal').className = 'terminal';
        document.getElementById('op-status').innerText = "RADAR ACTIVO";
        document.querySelectorAll('.feed-btn').forEach(b => b.classList.remove('active-signal'));
        sequence = [];
    }

    function injectManual(side) { sequence = []; for(let i=0; i<minRachaByLevel[riskLevel]; i++) sequence.push({val: side, diff: 200}); analyze(); }
    function setTime(s, btn) { document.querySelectorAll('.time-selector .btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); resetUI(); }
    
    function exportData() {
        if(tradeHistory.length === 0) return alert("No hay datos para exportar.");
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Tipo,Fuerza,Ruido,Riesgo,Flex,Resultado,Fecha\n"
            + tradeHistory.map(t => `${t.type},${t.strength},${t.noise},${t.risk},${t.flex},${t.resultado},${t.timestamp}`).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `quantum_data_${Date.now()}.csv`);
        document.body.appendChild(link);
        link.click();
    }
</script>
</body>
</html>
